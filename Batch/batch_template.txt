@echo off
setlocal enabledelayedexpansion


:: Get path of your current working location
:: and path that might be set 

set cPath=%~dp0
set argPath=%~1

:: code source file path

set "sPath=..\\Sets\\Code.txt"


REM normalize a file path of the code source file

:: Check if argPath is empty

if not defined argPath (
	set "argPath=%CD%"
)

:: Check if argPath is absolute (has drive letter)
:: Concatenate and normalize to full path
:: export to folder 

if "%argPath:~1,1%"==":" (
    rem Absolute path → use as-is
    for %%B in ("%argPath%") do set "resolved_argPath=%%~fB"
) else (
    rem Relative path → resolve against cPath
    for %%B in ("%CD%\%argPath%") do set "resolved_argPath=%%~fB"
)

:: Validate output directory exists

if not exist "%resolved_argPath%" (
	echo ERROR: There is no such directory
	rem echo %resolved_argPath%
	exit /b 1
)

:: Concatenate and normalize to full path
:: current working location

for %%C in ("%cPath%%sPath%") do set "resolved_sPath=%%~fC"

REM rPath - a variable where will be stored a path to the result of a program

echo.
echo File(s) will be created here:
echo %resolved_argPath%
echo. 

REM begin MAIN function

:: Read input file line by line

set /a ast = 2

for /f "usebackq tokens=*" %%L in ("%resolved_sPath%") do (
	
	
	set line=%%L
	
	echo !line! | findstr /C:"***" >nul
	if not errorlevel 1 (
		
		set /a ast = 2
	) else (
		
		set /a ast = 1
	)
	
	
	if !ast! GEQ 2 (
        
		rem Extract filename between the ***
		
		set "filename=!line:~4,-4!"
		set outfile=%resolved_argPath%\!filename!
		
		echo.>"!outfile!"
		
		echo File !filename! created
		
    	) else (
		
		rem Write line to file if inside a section
		if defined outfile (
		
			>>"!outfile!"= echo(!line!
		)
	)
)

REM end MAIN function

echo.
echo Done.